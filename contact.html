<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subway Runner 3D</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial Rounded MT Bold', sans-serif; background: #87ceeb; }
        
        /* UI Layers */
        #ui-container { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; pointer-events: none; }
        
        /* Start Menu */
        #menu { pointer-events: auto; display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.3); padding: 40px; border-radius: 30px; backdrop-filter: blur(5px); }
        #play-btn { width: 100px; height: 100px; background: #ffcc00; border: 6px solid white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 0 #cc9900; transition: transform 0.1s; }
        #play-btn:active { transform: translateY(5px); box-shadow: 0 5px 0 #cc9900; }
        #play-btn::after { content: ''; border-style: solid; border-width: 20px 0 20px 35px; border-color: transparent transparent transparent white; margin-left: 10px; }
        
        /* HUD */
        #hud { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; text-shadow: 3px 3px 0 #000; text-align: right; display: none; }
        #hover-timer { color: #00ffff; font-size: 18px; display: none; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    
    <div id="hud">
        SCORE: <span id="score-val">0</span><br>
        COINS: <span id="coin-val">0</span>
        <div id="hover-timer">HOVERBOARD ACTIVE</div>
    </div>

    <div id="ui-container">
        <div id="menu">
            <h1 style="color: white; font-size: 48px; margin: 0 0 20px 0; text-shadow: 3px 3px 0 #ff4500;">SUBWAY RUNNER</h1>
            <div id="play-btn" onclick="startGame()"></div>
            <p style="color: white; margin-top: 20px; font-weight: bold;">ARROWS: Move/Jump/Slide | SPACE: Hoverboard</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- GAME ENGINE VARIABLES ---
        let scene, camera, renderer, player, clock;
        let isPlaying = false, score = 0, coinsCount = 0, speed = 0;
        let lanes = [-3.5, 0, 3.5], currentLane = 1;
        let obstacles = [], coins = [], environmentPieces = [];
        let isHovering = false, jumpVelocity = 0, isSliding = false;

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(freq, type, dur) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.value = freq;
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // --- 3D INITIALIZATION ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 20, 100);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 6, 12);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(10, 20, 10);
            scene.add(sun);
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));

            createPlayer();
            createWorld();

            window.addEventListener('keydown', handleInput);
            animate();
        }

        function createPlayer() {
            player = new THREE.Group();
            
            // Character Body (Stylized like images)
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.5), new THREE.MeshStandardMaterial({color: 0x3366ff}));
            body.position.y = 1.6;
            player.add(body);
            
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 2.4;
            player.add(head);

            const hat = new THREE.Mesh(new THREE.BoxGeometry(0.55, 0.1, 0.6), new THREE.MeshStandardMaterial({color: 0xff4500}));
            hat.position.set(0, 2.6, 0.1);
            player.add(hat);

            // Hoverboard (Invisible)
            const board = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.2, 3), new THREE.MeshStandardMaterial({color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5}));
            board.name = "board";
            board.position.y = 0.2;
            board.visible = false;
            player.add(board);

            scene.add(player);
        }

        function createWorld() {
            // Track Floor
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(16, 2000), new THREE.MeshStandardMaterial({color: 0x444444}));
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // Rails
            lanes.forEach(x => {
                const rail = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 2000), new THREE.MeshStandardMaterial({color: 0x777777}));
                rail.position.set(x, 0.05, 0);
                scene.add(rail);
            });

            // City Environment: Houses & Overhead Wires
            for (let i = 0; i > -1000; i -= 25) {
                // Houses
                const h = Math.random() * 6 + 4;
                const house = new THREE.Mesh(new THREE.BoxGeometry(6, h, 6), new THREE.MeshStandardMaterial({color: new THREE.Color(`hsl(${Math.random()*360}, 60%, 50%)`)}));
                house.position.set(i % 50 === 0 ? -12 : 12, h/2, i);
                scene.add(house);

                // Poles and Wires
                if (i % 40 === 0) {
                    const pole = new THREE.Mesh(new THREE.BoxGeometry(0.3, 14, 0.3), new THREE.MeshStandardMaterial({color: 0x222222}));
                    pole.position.set(8, 7, i);
                    scene.add(pole);

                    const cross = new THREE.Mesh(new THREE.BoxGeometry(16, 0.2, 0.2), new THREE.MeshStandardMaterial({color: 0x222222}));
                    cross.position.set(0, 12, i);
                    scene.add(cross);
                }
            }
        }

        // --- GAME LOGIC ---
        function startGame() {
            audioCtx.resume();
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('hud').style.display = 'block';
            isPlaying = true;
            speed = 0.12; // Starts slowly
            score = 0;
            spawnLoop();
        }

        function handleInput(e) {
            if (!isPlaying) return;
            if (e.key === "ArrowLeft" && currentLane > 0) currentLane--;
            if (e.key === "ArrowRight" && currentLane < 2) currentLane++;
            if (e.key === "ArrowUp" && player.position.y < 0.1) {
                jumpVelocity = 0.45;
                playSfx(400, 'square', 0.1);
            }
            if (e.key === "ArrowDown") slide();
            if (e.key === " ") activateHoverboard();
        }

        function slide() {
            if (isSliding) return;
            isSliding = true;
            player.scale.y = 0.5;
            player.position.y = 0;
            playSfx(200, 'sawtooth', 0.1);
            setTimeout(() => { 
                player.scale.y = 1; 
                isSliding = false; 
            }, 800);
        }

        function activateHoverboard() {
            if (isHovering) return;
            isHovering = true;
            player.getObjectByName("board").visible = true;
            document.getElementById('hover-timer').style.display = 'block';
            playSfx(600, 'sine', 0.3);
            setTimeout(() => {
                isHovering = false;
                player.getObjectByName("board").visible = false;
                document.getElementById('hover-timer').style.display = 'none';
            }, 6000);
        }

        function spawnLoop() {
            if (!isPlaying) return;
            
            const r = Math.random();
            if (r > 0.4) {
                // Spawn Obstacle: Train (Large) or Barrier (Small)
                const isTrain = Math.random() > 0.6;
                const obs = new THREE.Mesh(
                    isTrain ? new THREE.BoxGeometry(3, 4, 12) : new THREE.BoxGeometry(3, 1.5, 0.5),
                    new THREE.MeshStandardMaterial({color: isTrain ? 0xdddddd : 0xff0000})
                );
                obs.position.set(lanes[Math.floor(Math.random()*3)], isTrain ? 2 : 0.75, player.position.z - 80);
                scene.add(obs);
                obstacles.push(obs);
            } else {
                // Spawn Coins
                const coin = new THREE.Mesh(new THREE.TorusGeometry(0.5, 0.15, 8, 20), new THREE.MeshStandardMaterial({color: 0xffcc00}));
                coin.position.set(lanes[Math.floor(Math.random()*3)], 1.5, player.position.z - 60);
                coin.rotation.y = Math.PI/2;
                scene.add(coin);
                coins.push(coin);
            }

            // Spawn rate gets faster as speed increases
            setTimeout(spawnLoop, Math.max(400, 1200 - (speed * 200)));
        }

        function animate() {
            requestAnimationFrame(animate);
            if (isPlaying) {
                speed += 0.0001; // Constant slow acceleration
                score += Math.floor(speed * 10);
                player.position.z -= speed;
                
                // HUD update
                document.getElementById('score-val').innerText = score;

                // Smooth Lane Transition
                player.position.x = THREE.MathUtils.lerp(player.position.x, lanes[currentLane], 0.15);

                // Jump Physics
                if (jumpVelocity !== 0 || player.position.y > 0) {
                    player.position.y += jumpVelocity;
                    jumpVelocity -= 0.022; // Gravity
                    if (player.position.y <= 0) {
                        player.position.y = 0;
                        jumpVelocity = 0;
                    }
                }

                // Camera follow
                camera.position.z = player.position.z + 12;
                camera.lookAt(player.position.x, 2, player.position.z - 5);

                // Collision Check
                obstacles.forEach((obs, i) => {
                    if (player.position.distanceTo(obs.position) < 2.2) {
                        if (isHovering) {
                            scene.remove(obs);
                            obstacles.splice(i, 1);
                            isHovering = false; // Shield used
                            player.getObjectByName("board").visible = false;
                            document.getElementById('hover-timer').style.display = 'none';
                            playSfx(100, 'sawtooth', 0.2);
                        } else {
                            isPlaying = false;
                            playSfx(50, 'sawtooth', 0.8);
                            alert("GAME OVER! Score: " + score);
                            location.reload();
                        }
                    }
                });

                // Coin Collection
                coins.forEach((c, i) => {
                    c.rotation.z += 0.1;
                    if (player.position.distanceTo(c.position) < 1.8) {
                        scene.remove(c);
                        coins.splice(i, 1);
                        coinsCount++;
                        document.getElementById('coin-val').innerText = coinsCount;
                        playSfx(1000, 'sine', 0.05);
                    }
                });
            }
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>